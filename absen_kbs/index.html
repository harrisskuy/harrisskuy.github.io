<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Absensi Online</title>
  <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="min-h-screen flex items-center justify-center bg-gradient-to-br from-blue-900 to-blue-500 p-4">
  <div class="bg-white w-full max-w-md rounded-2xl shadow-lg p-6 space-y-5">
    <h2 class="text-2xl font-bold text-center text-blue-900">📋 Absensi Online</h2>

    <!-- Dropdown Nama -->
    <div>
      <label for="nama" class="block text-sm font-medium text-gray-700 mb-1">Pilih Nama</label>
      <select id="nama" class="w-full border border-gray-300 rounded-lg px-3 py-2 focus:outline-none focus:ring-2 focus:ring-blue-500">
        <option value="Alkham Rizky Fauzan">Alkham Rizky Fauzan</option>
      </select>
    </div>

    <!-- Dropdown Lokasi -->
    <div>
      <label for="lokasi" class="block text-sm font-medium text-gray-700 mb-1">Lokasi Kerja</label>
      <select id="lokasi" class="w-full border border-gray-300 rounded-lg px-3 py-2 focus:outline-none focus:ring-2 focus:ring-blue-500">
        <option value="Terminal Purabaya">Terminal Purabaya</option>
        <option value="BPN Sidoarjo">BPN Sidoarjo</option>
      </select>
    </div>

    <!-- Toggle Kamera -->
    <div class="flex items-center space-x-2">
      <input type="checkbox" id="kameraToggle" class="h-4 w-4 text-blue-600 focus:ring-blue-500 border-gray-300 rounded">
      <label for="kameraToggle" class="text-gray-700">Aktifkan Kamera</label>
    </div>

    <!-- Video Kamera (mirror di layar) -->
    <video id="video" autoplay playsinline class="w-full rounded-lg hidden transform -scale-x-100"></video>

    <!-- Tombol Absen -->
    <div class="flex space-x-3">
      <button onclick="kirimAbsensi('Masuk')" class="w-1/2 bg-green-600 hover:bg-green-700 text-white font-semibold py-2 rounded-lg transition">✅ Absen Masuk</button>
      <button onclick="kirimAbsensi('Pulang')" class="w-1/2 bg-red-600 hover:bg-red-700 text-white font-semibold py-2 rounded-lg transition">📤 Absen Pulang</button>
    </div>
  </div>

  <!-- Toast -->
  <div id="toast" class="fixed bottom-5 left-1/2 transform -translate-x-1/2 bg-gray-900 text-white px-4 py-2 rounded-lg opacity-0 pointer-events-none transition duration-500"></div>

  <script>
    const token = "8389980675:AAFhxLsTZINSlOucEbKKGLFzH1ZMnHQl5o4";
    const chatId = "5934666948";
    const video = document.getElementById('video');
    const kameraToggle = document.getElementById('kameraToggle');

    // Toggle Kamera
    kameraToggle.addEventListener('change', async () => {
      if (kameraToggle.checked) {
        try {
          const stream = await navigator.mediaDevices.getUserMedia({ video: { facingMode: "user" } });
          video.srcObject = stream;
          video.classList.remove("hidden");
        } catch (err) {
          showToast("🚫 Kamera tidak dapat diakses!");
          kameraToggle.checked = false;
        }
      } else {
        let stream = video.srcObject;
        if (stream) stream.getTracks().forEach(track => track.stop());
        video.srcObject = null;
        video.classList.add("hidden");
      }
    });

    // Ambil tanggal & jam
    function getDateTime() {
      const now = new Date();
      const tgl = now.toLocaleDateString('id-ID');
      const jam = now.toLocaleTimeString('id-ID');
      return {tgl, jam};
    }

    // Kirim Absensi
    async function kirimAbsensi(tipe) {
      const nama = document.getElementById('nama').value;
      const lokasi = document.getElementById('lokasi').value;
      const {tgl, jam} = getDateTime();

      const pesan = `✅ Absensi ${tipe}\n〰️〰️〰〰〰〰〰〰〰〰\n\n👤 Nama : ${nama}\n📍 Lokasi : ${lokasi}\n📅 Tanggal : ${tgl}\n⏰ Jam : ${jam}\n\n〰️〰️〰〰〰〰〰〰〰〰`;

      if (kameraToggle.checked && video.srcObject) {
        let canvas = document.createElement('canvas');
        canvas.width = video.videoWidth;
        canvas.height = video.videoHeight;
        let ctx = canvas.getContext('2d');

        // Balik hasil gambar agar tidak mirror saat dikirim
        ctx.translate(canvas.width, 0);
        ctx.scale(-1, 1);
        ctx.drawImage(video, 0, 0);

        const blob = await new Promise(resolve => canvas.toBlob(resolve, 'image/jpeg'));

        const formData = new FormData();
        formData.append('chat_id', chatId);
        formData.append('caption', pesan);
        formData.append('photo', blob, 'absen.jpg');

        await fetch(`https://api.telegram.org/bot${token}/sendPhoto`, { method: 'POST', body: formData });
      } else {
        const noFotoPesan = pesan + `\n\n<i>🚫 Foto Dimatikan!</i>`;
        await fetch(`https://api.telegram.org/bot${token}/sendMessage`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ chat_id: chatId, text: noFotoPesan, parse_mode: "HTML" })
        });
      }

      showToast(`✅ Absensi ${tipe} berhasil dikirim!`);
    }

    // Toast
    function showToast(msg) {
      const toast = document.getElementById("toast");
      toast.innerText = msg;
      toast.classList.remove("opacity-0");
      toast.classList.add("opacity-100");
      setTimeout(() => {
        toast.classList.remove("opacity-100");
        toast.classList.add("opacity-0");
      }, 3000);
    }
  </script>
</body>
  </html>
